// --- FIREBASE INTEGRATION ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, getDocs, collection
} from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

// Tu configuraci√≥n de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyB4gsmP4npxwgHRN0882sqG-ruZj1DL0V0",
    authDomain: "mjcnt-c25a8.firebaseapp.com",
    projectId: "mjcnt-c25a8",
    storageBucket: "mjcnt-c25a8.appspot.com",
    messagingSenderId: "534683522875",
    appId: "1:534683522875:web:c53aa00beec9888446491e",
    measurementId: "G-6WB1D5N7Q7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- USUARIOS Y CONTRASE√ëAS LOCALES ---
const USERS = {
    "fila 1": "fila",
    "fila 2": "fila",
    "fila 3": "fila",
    "fila 4": "fila",
    "profesoranatu": "2025naturales2025juegos"
};
const FILAS_VALIDAS = ["fila 1", "fila 2", "fila 3", "fila 4"];
const PROFESORA = "profesoranatu";

// --- SESI√ìN ---
function saveSession(user) { localStorage.setItem('user', user); }
function getSession() { return localStorage.getItem('user'); }
function clearSession() { localStorage.removeItem('user'); }

// --- GLOBALES ---
let currentUser = null;
let currentGame = null;
let gameData = null;

// --- FIRESTORE FUNCIONES ---
async function getFilaCoins(fila) {
    const ref = doc(db, "filas", fila);
    const snap = await getDoc(ref);
    if (snap.exists() && typeof snap.data().coins !== "undefined") {
        return Number(snap.data().coins) || 0;
    }
    await setDoc(ref, { coins: 0 });
    return 0;
}
async function setCoinsDB(fila, coins) {
    const ref = doc(db, "filas", fila);
    await setDoc(ref, { coins: Number(coins) }, { merge: true });
}
async function getAllFilasFromDB() {
    const snapshot = await getDocs(collection(db, "filas"));
    let filasData = {};
    snapshot.forEach(doc => filasData[doc.id] = doc.data());
    return filasData;
}
async function setMultipleCoinsDB(filasConMonedas) {
    const promises = [];
    for (const fila in filasConMonedas) {
        promises.push(setCoinsDB(fila, filasConMonedas[fila]));
    }
    await Promise.all(promises);
}
async function sumarCoinsAFila(fila, cantidad) {
    const prevCoins = await getFilaCoins(fila);
    const newCoins = prevCoins + Number(cantidad);
    await setCoinsDB(fila, newCoins);
}

// --- LOGIN Y LOGOUT ---
function wait(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

window.login = async function login() {
    const username = document.getElementById('username').value.toLowerCase().trim();
    const password = document.getElementById('password').value;

    if (!USERS[username] || USERS[username] !== password) {
        await wait(2000); // Espera 2 segundos
        alert('Usuario o contrase√±a incorrectos');
        return;
    }
    
    currentUser = username;
    saveSession(username);
    document.getElementById('loginScreen').classList.add('hidden');
    document.querySelector('.logout-btn').classList.remove('hidden');
    if (username === PROFESORA) {
        document.getElementById('teacherScreen').classList.remove('hidden');
        await loadTeacherPanel();
    } else {
        document.getElementById('studentScreen').classList.remove('hidden');
        document.getElementById('currentUser').textContent = username.toUpperCase();
        document.getElementById('filaBadge').textContent = username.toUpperCase();
        onSnapshot(doc(db, "filas", username), async snap => {
            let coins = 0;
            if (snap.exists()) {
                coins = Number(snap.data().coins) || 0;
            } else {
                await setDoc(doc(db, "filas", username), { coins: 0 });
                coins = 0;
            }
            document.getElementById('userCoins').textContent = coins;
        });
    }
};
window.logout = function logout() {
    currentUser = null;
    clearSession();
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('studentScreen').classList.add('hidden');
    document.getElementById('teacherScreen').classList.add('hidden');
    document.querySelector('.logout-btn').classList.add('hidden');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    closeGame();
};
window.onload = async function() {
    const usuario = getSession();
    if (usuario) {
        document.getElementById('username').value = usuario;
        document.getElementById('password').value = '';
        await login();
    }
};

// --- PANEL PROFESORA ---
window.loadTeacherPanel = async function loadTeacherPanel() {
    const filas = await getAllFilasFromDB();
    const filasManagement = document.getElementById('filasManagement');
    filasManagement.innerHTML = '';
    FILAS_VALIDAS.forEach(fila => {
        const coins = Number((filas[fila] && filas[fila].coins) || 0);
        const filaDiv = document.createElement('div');
        filaDiv.className = 'fila-row';
        filaDiv.innerHTML = `
            <div class="fila-info">
                <h4>${fila.toUpperCase()}</h4>
                <div class="fila-coins">üí∞ ${coins} Minecoins</div>
            </div>
            <div class="fila-controls">
                <input type="number" id="coins-${fila}" placeholder="Cantidad" min="1">
                <button class="btn btn-success" onclick="addCoinsToFila('${fila}')">+ Dar</button>
                <button class="btn btn-danger" onclick="removeCoinsFromFila('${fila}')">- Quitar</button>
            </div>
        `;
        filasManagement.appendChild(filaDiv);
    });
};
window.addCoinsToFila = async function addCoinsToFila(fila) {
    const input = document.getElementById(`coins-${fila}`);
    const amount = parseInt(input.value);
    if (!amount || amount <= 0) {
        alert('Ingresa una cantidad v√°lida');
        return;
    }
    const prevCoins = await getFilaCoins(fila);
    const newCoins = prevCoins + amount;
    await setCoinsDB(fila, newCoins);
    input.value = '';
    await loadTeacherPanel();
    alert(`Se agregaron ${amount} minecoins a ${fila.toUpperCase()}`);
};
window.removeCoinsFromFila = async function removeCoinsFromFila(fila) {
    const input = document.getElementById(`coins-${fila}`);
    const amount = parseInt(input.value);
    if (!amount || amount <= 0) {
        alert('Ingresa una cantidad v√°lida');
        return;
    }
    const prevCoins = await getFilaCoins(fila);
    const newCoins = Math.max(0, prevCoins - amount);
    await setCoinsDB(fila, newCoins);
    input.value = '';
    await loadTeacherPanel();
    alert(`Se quitaron ${amount} minecoins de ${fila.toUpperCase()}`);
};
window.addCoinsToAll = async function addCoinsToAll() {
    const amount = parseInt(document.getElementById('globalCoins').value);
    if (!amount || amount <= 0) {
        alert('Ingresa una cantidad v√°lida');
        return;
    }
    const filas = await getAllFilasFromDB();
    let updateObj = {};
    FILAS_VALIDAS.forEach(fila => {
        updateObj[fila] = (Number((filas[fila] && filas[fila].coins) || 0)) + amount;
    });
    await setMultipleCoinsDB(updateObj);
    document.getElementById('globalCoins').value = '';
    await loadTeacherPanel();
    alert(`Se agregaron ${amount} minecoins a todas las filas`);
};
window.removeCoinsFromAll = async function removeCoinsFromAll() {
    const amount = parseInt(document.getElementById('globalCoins').value);
    if (!amount || amount <= 0) {
        alert('Ingresa una cantidad v√°lida');
        return;
    }
    const filas = await getAllFilasFromDB();
    let updateObj = {};
    FILAS_VALIDAS.forEach(fila => {
        updateObj[fila] = Math.max(0, (Number((filas[fila] && filas[fila].coins) || 0)) - amount);
    });
    await setMultipleCoinsDB(updateObj);
    document.getElementById('globalCoins').value = '';
    await loadTeacherPanel();
    alert(`Se quitaron ${amount} minecoins de todas las filas`);
};

// --- FUNCION PARA RANDOMIZAR ---
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// --- PREGUNTAS Y DATOS JUEGOS ---
// (gameQuestions, memoryCards, crucigrama)
const gameQuestions = {
    biosfera: [
        { question: "¬øQu√© es la biosfera?", options: ["El conjunto de todos los seres vivos del planeta", "Solo los oc√©anos", "Solo la atm√≥sfera", "Solo las plantas"], correct: 0 },
        { question: "¬øQu√© gas producen las plantas durante la fotos√≠ntesis?", options: ["Ox√≠geno", "Di√≥xido de carbono", "Nitr√≥geno", "Metano"], correct: 0 },
        { question: "¬øCu√°l es la fuente principal de energ√≠a para la biosfera?", options: ["El sol", "El viento", "El agua", "La luna"], correct: 0 },
        { question: "¬øQu√© capa de la Tierra contiene la biosfera?", options: ["Litosfera", "Hidrosfera", "Atm√≥sfera", "Todas"], correct: 3 },
        { question: "¬øQu√© organismo es considerado un descomponedor?", options: ["√Årbol", "Hongo", "Conejo", "Pez"], correct: 1 },
        { question: "¬øQu√© ciclo describe el movimiento del agua en la Tierra?", options: ["Ciclo del ox√≠geno", "Ciclo del agua", "Ciclo del carbono", "Ciclo del nitr√≥geno"], correct: 1 },
        { question: "¬øC√≥mo se llama el conjunto de organismos de una misma especie en un √°rea?", options: ["Poblaci√≥n", "Comunidad", "Ecosistema", "Biosfera"], correct: 0 },
        { question: "¬øCu√°l es el principal gas de efecto invernadero?", options: ["Ox√≠geno", "Di√≥xido de carbono", "Nitr√≥geno", "Helio"], correct: 1 },
        { question: "¬øQu√© animales pertenecen al grupo de los consumidores primarios?", options: ["Plantas", "Herb√≠voros", "Carn√≠voros", "Descomponedores"], correct: 1 },
        { question: "¬øCu√°l de estos es un ejemplo de mutualismo?", options: ["Abeja y flor", "Le√≥n y cebra", "Hongo y √°rbol muerto", "Lobo y conejo"], correct: 0 }
    ],
    vertebrados: [
        { question: "¬øCu√°l de estos animales es un mam√≠fero?", options: ["Serpiente", "Delf√≠n", "√Åguila", "Rana"], correct: 1 },
        { question: "¬øQu√© caracter√≠stica tienen todos los vertebrados?", options: ["Plumas", "Columna vertebral", "Branquias", "Pelos"], correct: 1 },
        { question: "¬øCu√°l de estos es un anfibio?", options: ["Lagarto", "Salamandra", "Pez", "Ave"], correct: 1 },
        { question: "¬øCu√°ntas c√°maras tiene el coraz√≥n de un ave?", options: ["2", "3", "4", "5"], correct: 2 },
        { question: "¬øQu√© tipo de animal pone huevos con c√°scara dura?", options: ["Mam√≠feros", "Anfibios", "Reptiles", "Peces"], correct: 2 },
        { question: "¬øCu√°l de estos animales es ov√≠paro?", options: ["Ballena", "Cebra", "Gallina", "Perro"], correct: 2 },
        { question: "¬øQu√© animal respira por branquias?", options: ["Gato", "Tibur√≥n", "√Åguila", "Lobo"], correct: 1 },
        { question: "¬øCu√°l es el grupo m√°s numeroso de vertebrados?", options: ["Mam√≠feros", "Aves", "Peces", "Anfibios"], correct: 2 },
        { question: "¬øQu√© animal es de sangre fr√≠a?", options: ["Delf√≠n", "Serpiente", "Humano", "Perro"], correct: 1 },
        { question: "¬øQu√© grupo tiene plumas?", options: ["Aves", "Reptiles", "Peces", "Anfibios"], correct: 0 }
    ],
    invertebrados: [
        { question: "¬øCu√°ntas patas tiene un insecto?", options: ["4", "6", "8", "10"], correct: 1 },
        { question: "¬øCu√°l de estos animales es un molusco?", options: ["Ara√±a", "Caracol", "Lib√©lula", "Cangrejo"], correct: 1 },
        { question: "¬øC√≥mo se llama el proceso de cambio de larva a adulto?", options: ["Metamorfosis", "Reproducci√≥n", "Digesti√≥n", "Respiraci√≥n"], correct: 0 },
        { question: "¬øCu√°l es el invertebrado m√°s grande del mundo?", options: ["Pulpo gigante", "Calamar colosal", "Medusa gigante", "Ara√±a Goliat"], correct: 1 },
        { question: "¬øCu√°ntas patas tienen los ar√°cnidos?", options: ["6", "8", "10", "12"], correct: 1 },
        { question: "¬øCu√°l de estos NO es invertebrado?", options: ["Lombriz", "Mariposa", "Tibur√≥n", "Caracol"], correct: 2 },
        { question: "¬øA qu√© grupo pertenece la medusa?", options: ["Moluscos", "Por√≠feros", "Cnidarios", "Artr√≥podos"], correct: 2 },
        { question: "¬øQu√© animal fabrica seda?", options: ["Ara√±a", "Hormiga", "Escarabajo", "Ciempi√©s"], correct: 0 },
        { question: "¬øCu√°l de los siguientes es un crust√°ceo?", options: ["Cangrejo", "Mariposa", "Ara√±a", "Lombriz"], correct: 0 },
        { question: "¬øC√≥mo se llaman los insectos que pasan por pupa?", options: ["Holomet√°bolos", "Hemimet√°bolos", "Amet√°bolos", "Isomet√°bolos"], correct: 0 }
    ],
    plantas: [
        { question: "¬øQu√© parte de la planta absorbe agua?", options: ["Ra√≠z", "Tallo", "Hoja", "Flor"], correct: 0 },
        { question: "¬øD√≥nde ocurre la fotos√≠ntesis?", options: ["Ra√≠z", "Hoja", "Flor", "Semilla"], correct: 1 },
        { question: "¬øQu√© transporta el xilema?", options: ["Agua", "Az√∫cares", "Ox√≠geno", "CO2"], correct: 0 },
        { question: "¬øQu√© parte de la flor produce polen?", options: ["Estambre", "Pistilo", "Hoja", "Ra√≠z"], correct: 0 },
        { question: "¬øQu√© necesitan las plantas para crecer?", options: ["Luz, agua y aire", "Solo agua", "Solo tierra", "Solo aire"], correct: 0 },
        { question: "¬øC√≥mo se llama la p√©rdida de agua en hojas?", options: ["Fotos√≠ntesis", "Transpiraci√≥n", "Germinaci√≥n", "Polinizaci√≥n"], correct: 1 },
        { question: "¬øCu√°l es el √≥rgano sexual femenino de la flor?", options: ["Estambre", "Pistilo", "Petalo", "S√©palo"], correct: 1 },
        { question: "¬øQu√© tipo de planta pierde hojas en oto√±o?", options: ["Perennes", "Caduco", "Sucu", "Ep√≠fita"], correct: 1 },
        { question: "¬øQu√© producen las semillas?", options: ["Nuevas plantas", "Flores", "Frutos", "Ra√≠ces"], correct: 0 },
        { question: "¬øQu√© parte protege la semilla?", options: ["Fruto", "Ra√≠z", "Tallo", "Flor"], correct: 0 }
    ],
    agua: [
        { question: "¬øQu√© estado del agua es el hielo?", options: ["S√≥lido", "L√≠quido", "Gaseoso", "Plasma"], correct: 0 },
        { question: "¬øC√≥mo se llama el cambio de l√≠quido a gas?", options: ["Evaporaci√≥n", "Condensaci√≥n", "Sublimaci√≥n", "Fusi√≥n"], correct: 0 },
        { question: "¬øQu√© ciclo describe el viaje del agua en la naturaleza?", options: ["Ciclo del agua", "Ciclo del ox√≠geno", "Ciclo del carbono", "Ciclo del nitr√≥geno"], correct: 0 },
        { question: "¬øC√≥mo se llama el agua subterr√°nea almacenada?", options: ["Acu√≠fero", "Lago", "R√≠o", "Glaciar"], correct: 0 },
        { question: "¬øQu√© porcentaje del agua en la Tierra es dulce?", options: ["3%", "20%", "50%", "97%"], correct: 0 },
        { question: "¬øQu√© capa contiene la mayor parte del agua?", options: ["Hidrosfera", "Atm√≥sfera", "Litosfera", "Biosfera"], correct: 0 },
        { question: "¬øQu√© proceso forma las nubes?", options: ["Condensaci√≥n", "Evaporaci√≥n", "Precipitaci√≥n", "Fusi√≥n"], correct: 0 },
        { question: "¬øQu√© es el deshielo?", options: ["Derretimiento del hielo", "Evaporaci√≥n del agua", "Congelamiento", "Condensaci√≥n"], correct: 0 },
        { question: "¬øC√≥mo se llama el agua que cae como lluvia?", options: ["Precipitaci√≥n", "Condensaci√≥n", "Filtraci√≥n", "Evaporaci√≥n"], correct: 0 },
        { question: "¬øLa mayor parte del agua dulce est√° en...?", options: ["Glaciares", "R√≠os", "Mares", "Acu√≠feros"], correct: 0 }
    ],
    energia: [
        { question: "¬øCu√°l es la fuente primaria de energ√≠a en la Tierra?", options: ["El sol", "El viento", "El petr√≥leo", "El carb√≥n"], correct: 0 },
        { question: "La energ√≠a el√©ctrica se transporta por...", options: ["Cables", "Tuber√≠as", "Carreteras", "Redes sociales"], correct: 0 },
        { question: "¬øQu√© es una energ√≠a renovable?", options: ["Inagotable", "Contamina mucho", "Se agota", "No existe"], correct: 0 },
        { question: "¬øCu√°l NO es energ√≠a renovable?", options: ["Solar", "E√≥lica", "Petr√≥leo", "Hidr√°ulica"], correct: 2 },
        { question: "¬øQu√© aparato transforma energ√≠a el√©ctrica en luz?", options: ["Bombilla", "Motor", "Bater√≠a", "Turbina"], correct: 0 },
        { question: "¬øQu√© aparato transforma energ√≠a el√©ctrica en movimiento?", options: ["Motor", "Bombilla", "Radiador", "Ventilador"], correct: 0 },
        { question: "¬øC√≥mo se llama la energ√≠a almacenada en los alimentos?", options: ["Qu√≠mica", "Luminosa", "El√©ctrica", "T√©rmica"], correct: 0 },
        { question: "¬øQu√© energ√≠a tienen los cuerpos en movimiento?", options: ["Cin√©tica", "Potencial", "Luminosa", "Nuclear"], correct: 0 },
        { question: "¬øQu√© energ√≠a aprovecha las olas del mar?", options: ["Mareomotriz", "Solar", "E√≥lica", "Geot√©rmica"], correct: 0 },
        { question: "¬øQu√© energ√≠a se produce con paneles solares?", options: ["Solar", "E√≥lica", "Mec√°nica", "Qu√≠mica"], correct: 0 }
    ],
    aire: [
        { question: "¬øCu√°l es el gas m√°s abundante en el aire?", options: ["Nitr√≥geno", "Ox√≠geno", "CO2", "Arg√≥n"], correct: 0 },
        { question: "¬øQu√© gas respiramos los humanos?", options: ["Ox√≠geno", "Nitr√≥geno", "CO2", "Ozono"], correct: 0 },
        { question: "¬øCu√°l es el proceso donde las plantas producen ox√≠geno?", options: ["Fotos√≠ntesis", "Respiraci√≥n", "Evaporaci√≥n", "Condensaci√≥n"], correct: 0 },
        { question: "¬øD√≥nde ocurre la mayor parte de la vida a√©rea?", options: ["Troposfera", "Estratosfera", "Mesosfera", "Termosfera"], correct: 0 },
        { question: "¬øQu√© contaminante proviene de los autos?", options: ["Mon√≥xido de carbono", "Ozono", "Nitr√≥geno", "Arg√≥n"], correct: 0 },
        { question: "¬øQu√© gas contribuye al efecto invernadero?", options: ["CO2", "Ox√≠geno", "Nitr√≥geno", "Helio"], correct: 0 },
        { question: "¬øQu√© forma la lluvia √°cida?", options: ["Contaminantes", "Ozono", "Vapor de agua", "CO2"], correct: 0 },
        { question: "¬øQu√© instrumento mide la presi√≥n del aire?", options: ["Bar√≥metro", "Term√≥metro", "Anem√≥metro", "Pluvi√≥metro"], correct: 0 },
        { question: "¬øC√≥mo se llama el movimiento del aire?", options: ["Viento", "Oleaje", "Corriente", "Marea"], correct: 0 },
        { question: "¬øQu√© capa protege de rayos UV?", options: ["Ozono", "CO2", "Nitr√≥geno", "Arg√≥n"], correct: 0 }
    ],
    suelo: [
        { question: "¬øD√≥nde viven las lombrices?", options: ["Suelo", "Agua", "Aire", "Hojas"], correct: 0 },
        { question: "¬øQu√© capa de la Tierra cultivamos?", options: ["Superficial", "Profunda", "N√∫cleo", "Manto"], correct: 0 },
        { question: "¬øC√≥mo se llama la capa f√©rtil del suelo?", options: ["Humus", "Arena", "Roca", "Arcilla"], correct: 0 },
        { question: "¬øQu√© animal ayuda a airear el suelo?", options: ["Lombriz", "Gato", "Perro", "Rat√≥n"], correct: 0 },
        { question: "¬øQu√© planta fija nitr√≥geno?", options: ["Leguminosa", "Cactus", "Pino", "Roble"], correct: 0 },
        { question: "¬øQu√© es la erosi√≥n?", options: ["Desgaste del suelo", "Formaci√≥n de suelo", "Riego", "Siembra"], correct: 0 },
        { question: "¬øQu√© es un mineral?", options: ["Sustancia inorg√°nica", "Planta", "Animal", "Microbio"], correct: 0 },
        { question: "¬øPara qu√© sirve el compost?", options: ["Abonar", "Quemar", "Construir", "Limpiar"], correct: 0 },
        { question: "¬øQu√© aporta el humus?", options: ["Nutrientes", "Pl√°stico", "Piedras", "Arena"], correct: 0 },
        { question: "¬øQu√© es la arcilla?", options: ["Tipo de suelo", "Planta", "Animal", "Gas"], correct: 0 }
    ],
    cuerpo: [
        { question: "¬øCu√°l es el √≥rgano principal de la sangre?", options: ["Coraz√≥n", "Cerebro", "Pulm√≥n", "H√≠gado"], correct: 0 },
        { question: "¬øD√≥nde se realiza la digesti√≥n?", options: ["Est√≥mago", "Coraz√≥n", "Huesos", "Pulm√≥n"], correct: 0 },
        { question: "¬øQu√© sistema controla los movimientos?", options: ["Nervioso", "Digestivo", "Respiratorio", "√ìseo"], correct: 0 },
        { question: "¬øQu√© hueso protege el cerebro?", options: ["Cr√°neo", "F√©mur", "Tibia", "Radio"], correct: 0 },
        { question: "¬øCu√°ntos pulmones tiene el ser humano?", options: ["2", "3", "1", "4"], correct: 0 },
        { question: "¬øQu√© √≥rgano filtra la sangre?", options: ["Ri√±√≥n", "Pulm√≥n", "Coraz√≥n", "Est√≥mago"], correct: 0 },
        { question: "¬øCu√°l es el hueso m√°s largo?", options: ["F√©mur", "H√∫mero", "Cr√°neo", "Tibia"], correct: 0 },
        { question: "¬øD√≥nde est√°n los alveolos?", options: ["Pulmones", "Est√≥mago", "Ri√±√≥n", "Coraz√≥n"], correct: 0 },
        { question: "¬øC√≥mo se llama el tubo digestivo?", options: ["Intestino", "Vena", "Arteria", "Alv√©olo"], correct: 0 },
        { question: "¬øQu√© sistema transporta ox√≠geno?", options: ["Circulatorio", "Digestivo", "Nervioso", "√ìseo"], correct: 0 }
    ],
    sentidos: [
        { question: "¬øCon qu√© √≥rgano vemos?", options: ["Ojo", "Oreja", "Nariz", "Mano"], correct: 0 },
        { question: "¬øQu√© sentido usa la lengua?", options: ["Gusto", "O√≠do", "Vista", "Tacto"], correct: 0 },
        { question: "¬øCu√°l es el √≥rgano del olfato?", options: ["Nariz", "Boca", "O√≠do", "Ojo"], correct: 0 },
        { question: "¬øQu√© sentido necesita la piel?", options: ["Tacto", "Gusto", "Vista", "O√≠do"], correct: 0 },
        { question: "¬øQu√© sentido usamos para escuchar?", options: ["O√≠do", "Vista", "Tacto", "Gusto"], correct: 0 },
        { question: "¬øD√≥nde est√°n las papilas gustativas?", options: ["Lengua", "Nariz", "O√≠do", "Ojo"], correct: 0 },
        { question: "¬øQu√© √≥rgano capta la luz?", options: ["Ojo", "O√≠do", "Nariz", "Lengua"], correct: 0 },
        { question: "¬øQu√© sentido capta las temperaturas?", options: ["Tacto", "O√≠do", "Gusto", "Vista"], correct: 0 },
        { question: "¬øQu√© √≥rgano tiene t√≠mpano?", options: ["O√≠do", "Ojo", "Nariz", "Lengua"], correct: 0 },
        { question: "¬øQu√© sentido ayuda a identificar sabores?", options: ["Gusto", "O√≠do", "Vista", "Tacto"], correct: 0 }
    ],
    alimentos: [
        { question: "¬øQu√© alimento es fuente de prote√≠na?", options: ["Carne", "Az√∫car", "Aceite", "Sal"], correct: 0 },
        { question: "¬øQu√© alimento es fuente de energ√≠a r√°pida?", options: ["Az√∫car", "Carne", "Agua", "Sal"], correct: 0 },
        { question: "¬øQu√© mineral aporta la leche?", options: ["Calcio", "Hierro", "Yodo", "Potasio"], correct: 0 },
        { question: "¬øQu√© alimento es rico en fibra?", options: ["Frutas", "Az√∫car", "Sal", "Carne"], correct: 0 },
        { question: "¬øQu√© vitamina aporta la naranja?", options: ["Vitamina C", "Vitamina A", "Vitamina D", "Vitamina K"], correct: 0 },
        { question: "¬øQu√© alimento es fuente de hierro?", options: ["Lenteja", "Harina", "Aceite", "Sal"], correct: 0 },
        { question: "¬øQu√© tipo de alimento es la papa?", options: ["Tub√©rculo", "Fruta", "Carne", "L√°cteo"], correct: 0 },
        { question: "¬øQu√© alimento es fuente de grasa saludable?", options: ["Aceite de oliva", "Harina", "Az√∫car", "Sal"], correct: 0 },
        { question: "¬øQu√© grupo alimenticio aporta energ√≠a principal?", options: ["Carbohidratos", "Vitaminas", "Minerales", "Agua"], correct: 0 },
        { question: "¬øQu√© mineral previene la anemia?", options: ["Hierro", "Calcio", "Yodo", "Magnesio"], correct: 0 }
    ],
    animales: [
        { question: "¬øQu√© animal es un mam√≠fero?", options: ["Ballena", "Cocodrilo", "Gallina", "Tortuga"], correct: 0 },
        { question: "¬øQu√© animal pone huevos?", options: ["Gallina", "Vaca", "Perro", "Gato"], correct: 0 },
        { question: "¬øQu√© animal es un reptil?", options: ["Serpiente", "Delf√≠n", "Pato", "Le√≥n"], correct: 0 },
        { question: "¬øQu√© animal vuela?", options: ["√Åguila", "Elefante", "Tibur√≥n", "Rana"], correct: 0 },
        { question: "¬øQu√© animal tiene aletas?", options: ["Tibur√≥n", "√Åguila", "Le√≥n", "Caballo"], correct: 0 },
        { question: "¬øQu√© animal es un insecto?", options: ["Mariposa", "Rat√≥n", "Tortuga", "Pato"], correct: 0 },
        { question: "¬øQu√© animal vive en el agua?", options: ["Pez", "Perro", "Ave", "Gato"], correct: 0 },
        { question: "¬øQu√© animal es ov√≠paro?", options: ["Gallina", "Gato", "Perro", "Humano"], correct: 0 },
        { question: "¬øQu√© animal es herb√≠voro?", options: ["Vaca", "Le√≥n", "Tibur√≥n", "Serpiente"], correct: 0 },
        { question: "¬øQu√© animal es carn√≠voro?", options: ["Le√≥n", "Vaca", "Caballo", "Conejo"], correct: 0 }
    ],
    universo: [
        { question: "¬øCu√°l es el planeta m√°s cercano al Sol?", options: ["Mercurio", "Venus", "Tierra", "Marte"], correct: 0 },
        { question: "¬øQu√© estrella est√° m√°s cerca de la Tierra?", options: ["El Sol", "Sirio", "Proxima Centauri", "Betelgeuse"], correct: 0 },
        { question: "¬øCu√°ntos planetas hay en el sistema solar?", options: ["8", "7", "9", "10"], correct: 0 },
        { question: "¬øQu√© planeta es conocido como el planeta rojo?", options: ["Marte", "Venus", "J√∫piter", "Saturno"], correct: 0 },
        { question: "¬øC√≥mo se llama la galaxia donde vivimos?", options: ["V√≠a L√°ctea", "Andr√≥meda", "Magallanes", "Centauro"], correct: 0 },
        { question: "¬øQu√© planeta tiene anillos visibles?", options: ["Saturno", "Tierra", "Marte", "Venus"], correct: 0 },
        { question: "¬øCu√°l es el sat√©lite natural de la Tierra?", options: ["La Luna", "El Sol", "Marte", "J√∫piter"], correct: 0 },
        { question: "¬øQu√© astro da luz y calor a la Tierra?", options: ["El Sol", "La Luna", "Marte", "Venus"], correct: 0 },
        { question: "¬øCu√°nto tarda la Tierra en dar la vuelta al Sol?", options: ["1 a√±o", "1 mes", "1 semana", "1 d√≠a"], correct: 0 },
        { question: "¬øQu√© planeta es el m√°s grande?", options: ["J√∫piter", "Tierra", "Venus", "Saturno"], correct: 0 }
    ],
    materia: [
        { question: "¬øEn cu√°ntos estados se presenta la materia?", options: ["3", "2", "4", "5"], correct: 0 },
        { question: "¬øCu√°l NO es un estado de la materia?", options: ["Pl√°stico", "S√≥lido", "L√≠quido", "Gaseoso"], correct: 0 },
        { question: "¬øQu√© estado tiene forma y volumen definidos?", options: ["S√≥lido", "L√≠quido", "Gas", "Plasma"], correct: 0 },
        { question: "¬øQu√© cambio ocurre al derretir hielo?", options: ["Fusi√≥n", "Evaporaci√≥n", "Sublimaci√≥n", "Condensaci√≥n"], correct: 0 },
        { question: "¬øQu√© es una mezcla?", options: ["Combinaci√≥n de sustancias", "Elemento puro", "Gas", "√Åtomo"], correct: 0 },
        { question: "¬øQu√© es un √°tomo?", options: ["Part√≠cula m√≠nima", "Mol√©cula", "Elemento", "Mezcla"], correct: 0 },
        { question: "¬øQu√© es un compuesto?", options: ["Dos o m√°s elementos", "Un solo elemento", "Gas", "S√≥lido"], correct: 0 },
        { question: "¬øQu√© es evaporaci√≥n?", options: ["L√≠quido a gas", "S√≥lido a gas", "Gas a l√≠quido", "S√≥lido a l√≠quido"], correct: 0 },
        { question: "¬øQu√© es condensaci√≥n?", options: ["Gas a l√≠quido", "L√≠quido a gas", "S√≥lido a l√≠quido", "L√≠quido a s√≥lido"], correct: 0 },
        { question: "¬øQu√© es una soluci√≥n?", options: ["Mezcla homog√©nea", "Mezcla heterog√©nea", "Elemento", "Compuesto"], correct: 0 }
    ],
    tecnologia: [
        { question: "¬øQu√© invento permite hablar a distancia?", options: ["Tel√©fono", "Televisor", "Radio", "Computadora"], correct: 0 },
        { question: "¬øQu√© aparato sirve para calcular?", options: ["Calculadora", "L√°mpara", "Rat√≥n", "Reloj"], correct: 0 },
        { question: "¬øQu√© aparato proyecta im√°genes?", options: ["Proyector", "Ventilador", "Balanza", "Licuadora"], correct: 0 },
        { question: "¬øQu√© invento revolucion√≥ la escritura?", options: ["Imprenta", "L√°mpara", "Bicicleta", "Reloj"], correct: 0 },
        { question: "¬øQu√© aparato graba sonidos?", options: ["Grabadora", "Televisor", "Term√≥metro", "Bicicleta"], correct: 0 },
        { question: "¬øQu√© aparato mide la temperatura?", options: ["Term√≥metro", "Bar√≥metro", "Microscopio", "Lupa"], correct: 0 },
        { question: "¬øQu√© aparato permite ver cosas peque√±as?", options: ["Microscopio", "Televisor", "Reloj", "Im√°n"], correct: 0 },
        { question: "¬øQu√© aparato sirve para escribir en la computadora?", options: ["Teclado", "Pantalla", "Bocina", "Mouse"], correct: 0 },
        { question: "¬øQu√© invento permiti√≥ volar?", options: ["Avi√≥n", "Auto", "Bicicleta", "Tren"], correct: 0 },
        { question: "¬øQu√© invento sirve para iluminar de noche?", options: ["L√°mpara", "Tel√©fono", "Reloj", "Rueda"], correct: 0 }
    ],
    historia: [
        { question: "¬øQui√©n descubri√≥ Am√©rica?", options: ["Crist√≥bal Col√≥n", "Magallanes", "Galileo", "Einstein"], correct: 0 },
        { question: "¬øEn qu√© a√±o se firm√≥ la independencia argentina?", options: ["1816", "1810", "1789", "1853"], correct: 0 },
        { question: "¬øQui√©n fue el primer presidente de Argentina?", options: ["Rivadavia", "San Mart√≠n", "Sarmiento", "Belgrano"], correct: 0 },
        { question: "¬øQu√© civilizaci√≥n construy√≥ las pir√°mides?", options: ["Egipcia", "Griega", "Romana", "China"], correct: 0 },
        { question: "¬øQui√©n invent√≥ la imprenta?", options: ["Gutenberg", "Newton", "Edison", "Tesla"], correct: 0 },
        { question: "¬øQu√© guerra termin√≥ en 1945?", options: ["Segunda Guerra Mundial", "Primera Guerra Mundial", "Independencia", "Civil"], correct: 0 },
        { question: "¬øQu√© se celebra el 25 de mayo en Argentina?", options: ["Revoluci√≥n de Mayo", "D√≠a de la Bandera", "Independencia", "Navidad"], correct: 0 },
        { question: "¬øQui√©n fue el libertador de Per√∫?", options: ["San Mart√≠n", "Bol√≠var", "Rivadavia", "Belgrano"], correct: 0 },
        { question: "¬øD√≥nde naci√≥ el tango?", options: ["Buenos Aires", "Madrid", "Roma", "Londres"], correct: 0 },
        { question: "¬øQui√©n fue Mar√≠a Curie?", options: ["Cient√≠fica", "Escritora", "Pintora", "Reina"], correct: 0 }
    ],
    salud: [
        { question: "¬øQu√© fruta es rica en vitamina C?", options: ["Naranja", "Papa", "Manzana", "Tomate"], correct: 0 },
        { question: "¬øPor qu√© es importante lavarse las manos?", options: ["Evita enfermedades", "Da sue√±o", "Ense√±a", "Aburre"], correct: 0 },
        { question: "¬øCu√°ntos vasos de agua se recomienda tomar al d√≠a?", options: ["8", "2", "1", "15"], correct: 0 },
        { question: "¬øQu√© es la fiebre?", options: ["Aumento de temperatura", "Dolor de cabeza", "Tos", "Sed"], correct: 0 },
        { question: "¬øQu√© se usa para curar heridas?", options: ["Agua y jab√≥n", "Tierra", "Aceite", "Sal"], correct: 0 },
        { question: "¬øQu√© √≥rgano filtra la sangre?", options: ["Ri√±√≥n", "Pulm√≥n", "Coraz√≥n", "Est√≥mago"], correct: 0 },
        { question: "¬øQu√© es una vacuna?", options: ["Protecci√≥n contra enfermedades", "Comida", "Ropa", "Juguete"], correct: 0 },
        { question: "¬øPor qu√© hay que dormir bien?", options: ["Recuperar energ√≠a", "Comer", "Jugar", "Correr"], correct: 0 },
        { question: "¬øQu√© ejercicio fortalece el coraz√≥n?", options: ["Correr", "Ver TV", "Dormir", "Comer"], correct: 0 },
        { question: "¬øQu√© previene la higiene dental?", options: ["Caries", "Resfriado", "Fiebre", "Tos"], correct: 0 }
    ],
    reciclaje: [
        { question: "¬øQu√© color es el tacho para pl√°stico?", options: ["Amarillo", "Verde", "Azul", "Rojo"], correct: 0 },
        { question: "¬øQu√© material es reciclable?", options: ["Papel", "Comida", "Huesos", "Tierra"], correct: 0 },
        { question: "¬øPor qu√© reciclar?", options: ["Cuidar el ambiente", "Gastar m√°s", "Enfermarse", "Contaminar"], correct: 0 },
        { question: "¬øQu√© se recicla en el contenedor azul?", options: ["Papel y cart√≥n", "Vidrio", "Comida", "Pl√°stico"], correct: 0 },
        { question: "¬øQu√© producto NO se puede reciclar?", options: ["Pa√±al usado", "Botella", "Lata", "Papel"], correct: 0 },
        { question: "¬øQu√© se hace con el vidrio?", options: ["Reciclar", "Quemar", "Comer", "Romper"], correct: 0 },
        { question: "¬øQu√© es compostar?", options: ["Hacer abono", "Quemar basura", "Plantar √°rboles", "Cortar c√©sped"], correct: 0 },
        { question: "¬øQu√© tipo de residuo es la c√°scara de banana?", options: ["Org√°nico", "Pl√°stico", "Vidrio", "Metal"], correct: 0 },
        { question: "¬øQu√© se hace con las pilas usadas?", options: ["Llevar a punto limpio", "Tirar al suelo", "Quemar", "Compostar"], correct: 0 },
        { question: "¬øQu√© significa reducir?", options: ["Producir menos residuos", "Comprar m√°s", "Tirar m√°s", "Contaminar"], correct: 0 },
        
    ]
};
const memoryCards = [
    { id: 1, name: 'Le√≥n', type: 'Mam√≠fero', emoji: 'ü¶Å' },
    { id: 2, name: '√Åguila', type: 'Ave', emoji: 'ü¶Ö' },
    { id: 3, name: 'Serpiente', type: 'Reptil', emoji: 'üêç' },
    { id: 4, name: 'Rana', type: 'Anfibio', emoji: 'üê∏' },
    { id: 5, name: 'Tibur√≥n', type: 'Pez', emoji: 'ü¶à' },
    { id: 6, name: 'Ara√±a', type: 'Ar√°cnido', emoji: 'üï∑Ô∏è' }
];
const crucigrama = {
    words: [
        { word: 'CELULA', clue: 'Unidad b√°sica de la vida', direction: 'horizontal', startRow: 2, startCol: 1 },
        { word: 'ECOSISTEMA', clue: 'Comunidad de seres vivos y su ambiente', direction: 'vertical', startRow: 1, startCol: 3 },
        { word: 'VERTEBRADO', clue: 'Animal con columna vertebral', direction: 'horizontal', startRow: 4, startCol: 2 },
        { word: 'BIOSFERA', clue: 'Conjunto de todos los seres vivos', direction: 'vertical', startRow: 2, startCol: 6 }
    ]
};

// --- JUEGOS ---
window.openGame = function openGame(gameType) {
    if (currentUser === PROFESORA) {
        alert('Los juegos son solo para estudiantes');
        return;
    }
    currentGame = gameType;
    const modal = document.getElementById('gameModal');
    modal.style.display = 'block';
    if (gameQuestions[gameType]) {
        startQuizGame(gameType);
    } else if (gameType === 'memoria') {
        startMemoryGame();
    } else if (gameType === 'crucigrama') {
        startCrucigramaGame();
    } else if (gameType === 'clasificacion') {
        startClasificacionGame();
    } else {
        document.getElementById('gameContent').innerHTML = '<h3>Juego en desarrollo</h3><p>Este juego estar√° disponible pronto.</p>';
    }
};
window.closeGame = function closeGame() {
    document.getElementById('gameModal').style.display = 'none';
    currentGame = null;
    gameData = null;
};

// --- QUIZ (opciones randomizadas) ---
window.startQuizGame = function startQuizGame(gameType) {
    const originalQuestions = gameQuestions[gameType];
    const questions = originalQuestions.map(q => {
        const optionObjs = q.options.map((opt, idx) => ({ option: opt, origIndex: idx }));
        shuffleArray(optionObjs);
        const newCorrect = optionObjs.findIndex(optObj => optObj.origIndex === q.correct);
        return {
            question: q.question,
            options: optionObjs.map(optObj => optObj.option),
            correct: newCorrect
        };
    });
    gameData = {
        questions: questions,
        currentQuestion: 0,
        score: 0,
        selectedAnswers: []
    };
    showQuestion();
};
window.showQuestion = function showQuestion() {
    const content = document.getElementById('gameContent');
    const question = gameData.questions[gameData.currentQuestion];
    const progress = ((gameData.currentQuestion + 1) / gameData.questions.length) * 100;
    content.innerHTML = `
        <h2>Quiz: ${currentGame.charAt(0).toUpperCase() + currentGame.slice(1)}</h2>
        <div class="game-progress">
            <div>Pregunta ${gameData.currentQuestion + 1} de ${gameData.questions.length}</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
            <div class="score-display">Puntuaci√≥n: ${gameData.score}/${gameData.questions.length}</div>
        </div>
        <div class="question">
            <h3>${question.question}</h3>
            <div class="options">
                ${question.options.map((option, index) => 
                    `<div class="option" onclick="selectAnswer(${index})">${option}</div>`
                ).join('')}
            </div>
        </div>
    `;
};
window.selectAnswer = function selectAnswer(selectedIndex) {
    const question = gameData.questions[gameData.currentQuestion];
    const options = document.querySelectorAll('.option');
    options.forEach(option => option.style.pointerEvents = 'none');
    options[question.correct].classList.add('correct');
    if (selectedIndex !== question.correct) {
        options[selectedIndex].classList.add('incorrect');
    } else {
        gameData.score++;
    }
    gameData.selectedAnswers.push(selectedIndex);
    setTimeout(() => {
        gameData.currentQuestion++;
        if (gameData.currentQuestion < gameData.questions.length) {
            showQuestion();
        } else {
            showQuizResults();
        }
    }, 2000);
};
window.showQuizResults = async function showQuizResults() {
    const content = document.getElementById('gameContent');
    const percentage = (gameData.score / gameData.questions.length) * 100;
    let reward = 0;
    if (percentage >= 75) {
        reward = currentGame === 'biosfera' ? 10 : 15;
    } else if (percentage >= 50) {
        reward = Math.floor((currentGame === 'biosfera' ? 10 : 15) * 0.5);
    }
    if (reward > 0) {
        await sumarCoinsAFila(currentUser, reward);
    }
    content.innerHTML = `
        <div class="game-completed">
            <h3>¬°Quiz Completado!</h3>
            <div class="score-display">
                Respuestas correctas: ${gameData.score}/${gameData.questions.length}
                <br>
                Porcentaje: ${percentage.toFixed(1)}%
            </div>
            ${reward > 0 ? 
                `<div class="coins-earned">
                    <div class="coin-icon">‚Çø</div>
                    ¬°Ganaste ${reward} Minecoins!
                </div>` : 
                '<p>Necesitas al menos 50% para ganar monedas. ¬°Int√©ntalo de nuevo!</p>'
            }
            <button class="btn" onclick="closeGame()" style="margin-top: 20px;">Cerrar</button>
            <button class="btn" onclick="startQuizGame('${currentGame}')" style="margin-top: 20px; margin-left: 10px;">Jugar de Nuevo</button>
        </div>
    `;
};

// --- MEMORIA ---
window.startMemoryGame = function startMemoryGame() {
    const cards = [...memoryCards, ...memoryCards].sort(() => Math.random() - 0.5);
    gameData = {
        cards: cards,
        flippedCards: [],
        matchedPairs: 0,
        moves: 0
    };
    const content = document.getElementById('gameContent');
    content.innerHTML = `
        <h2>Juego de Memoria - Animales</h2>
        <div class="game-progress">
            <div>Movimientos: <span id="moves">0</span></div>
            <div>Parejas encontradas: <span id="pairs">0</span>/6</div>
        </div>
        <div class="memory-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0;">
            ${cards.map((card, index) => 
                `<div class="memory-card" onclick="flipCard(${index})" data-id="${card.id}">
                    <div class="card-front">?</div>
                    <div class="card-back hidden">${card.emoji}<br><small>${card.name}</small></div>
                </div>`
            ).join('')}
        </div>
    `;
};
window.flipCard = function flipCard(index) {
    if (gameData.flippedCards.length === 2) return;
    const card = document.querySelectorAll('.memory-card')[index];
    if (card.classList.contains('flipped')) return;
    card.classList.add('flipped');
    card.querySelector('.card-front').classList.add('hidden');
    card.querySelector('.card-back').classList.remove('hidden');
    gameData.flippedCards.push(index);
    if (gameData.flippedCards.length === 2) {
        gameData.moves++;
        document.getElementById('moves').textContent = gameData.moves;
        setTimeout(checkMemoryMatch, 1000);
    }
};
window.checkMemoryMatch = function checkMemoryMatch() {
    const [first, second] = gameData.flippedCards;
    const cards = document.querySelectorAll('.memory-card');
    const firstId = gameData.cards[first].id;
    const secondId = gameData.cards[second].id;
    if (firstId === secondId) {
        cards[first].classList.add('matched');
        cards[second].classList.add('matched');
        gameData.matchedPairs++;
        document.getElementById('pairs').textContent = gameData.matchedPairs;
        if (gameData.matchedPairs === 6) {
            setTimeout(showMemoryResults, 500);
        }
    } else {
        cards[first].classList.remove('flipped');
        cards[first].querySelector('.card-front').classList.remove('hidden');
        cards[first].querySelector('.card-back').classList.add('hidden');
        cards[second].classList.remove('flipped');
        cards[second].querySelector('.card-front').classList.remove('hidden');
        cards[second].querySelector('.card-back').classList.add('hidden');
    }
    gameData.flippedCards = [];
};
window.showMemoryResults = async function showMemoryResults() {
    let reward = 12;
    if (gameData.moves <= 15) reward = 15;
    else if (gameData.moves > 25) reward = 8;
    await sumarCoinsAFila(currentUser, reward);
    const content = document.getElementById('gameContent');
    content.innerHTML = `
        <div class="game-completed">
            <h3>¬°Memoria Completada!</h3>
            <div class="score-display">
                Completado en ${gameData.moves} movimientos
            </div>
            <div class="coins-earned">
                <div class="coin-icon">‚Çø</div>
                ¬°Ganaste ${reward} Minecoins!
            </div>
            <button class="btn" onclick="closeGame()" style="margin-top: 20px;">Cerrar</button>
            <button class="btn" onclick="startMemoryGame()" style="margin-top: 20px; margin-left: 10px;">Jugar de Nuevo</button>
        </div>
    `;
};

// --- CRUCIGRAMA ---
window.startCrucigramaGame = function startCrucigramaGame() {
    const content = document.getElementById('gameContent');
    content.innerHTML = `
        <h2>Crucigrama Cient√≠fico</h2>
        <div class="crucigrama-container">
            <div class="clues">
                <h4>Pistas:</h4>
                <ol>
                    <li>Unidad b√°sica de la vida (6 letras)</li>
                    <li>Comunidad de seres vivos y su ambiente (10 letras)</li>
                    <li>Animal con columna vertebral (10 letras)</li>
                    <li>Conjunto de todos los seres vivos (8 letras)</li>
                </ol>
            </div>
            <div class="crucigrama-inputs" style="margin: 20px 0;">
                <div class="word-input">
                    <label>1. Horizontal:</label>
                    <input type="text" id="word1" maxlength="6" placeholder="CELULA">
                </div>
                <div class="word-input">
                    <label>2. Vertical:</label>
                    <input type="text" id="word2" maxlength="10" placeholder="ECOSISTEMA">
                </div>
                <div class="word-input">
                    <label>3. Horizontal:</label>
                    <input type="text" id="word3" maxlength="10" placeholder="VERTEBRADO">
                </div>
                <div class="word-input">
                    <label>4. Vertical:</label>
                    <input type="text" id="word4" maxlength="8" placeholder="BIOSFERA">
                </div>
            </div>
            <button class="btn" onclick="checkCrucigrama()">Verificar Respuestas</button>
        </div>
    `;
};
window.checkCrucigrama = async function checkCrucigrama() {
    const answers = {
        word1: 'CELULA',
        word2: 'ECOSISTEMA',
        word3: 'VERTEBRADO',
        word4: 'BIOSFERA'
    };
    let correct = 0;
    Object.keys(answers).forEach(wordId => {
        const input = document.getElementById(wordId);
        if (input.value.toUpperCase() === answers[wordId]) {
            correct++;
            input.style.backgroundColor = '#d4edda';
        } else {
            input.style.backgroundColor = '#f8d7da';
        }
    });
    const reward = Math.floor((correct / 4) * 20);
    if (reward > 0) {
        await sumarCoinsAFila(currentUser, reward);
    }
    setTimeout(() => {
        const content = document.getElementById('gameContent');
        content.innerHTML = `
            <div class="game-completed">
                <h3>Crucigrama Completado</h3>
                <div class="score-display">
                    Respuestas correctas: ${correct}/4
                </div>
                ${reward > 0 ? 
                    `<div class="coins-earned">
                        <div class="coin-icon">‚Çø</div>
                        ¬°Ganaste ${reward} Minecoins!
                    </div>` : 
                    '<p>¬°Sigue intentando para ganar monedas!</p>'
                }
                <button class="btn" onclick="closeGame()" style="margin-top: 20px;">Cerrar</button>
                <button class="btn" onclick="startCrucigramaGame()" style="margin-top: 20px; margin-left: 10px;">Intentar de Nuevo</button>
            </div>
        `;
    }, 2000);
};

// --- CLASIFICACION ---
window.startClasificacionGame = function startClasificacionGame() {
    const animals = [
        { name: 'Le√≥n', group: 'Mam√≠feros', emoji: 'ü¶Å' },
        { name: '√Åguila', group: 'Aves', emoji: 'ü¶Ö' },
        { name: 'Serpiente', group: 'Reptiles', emoji: 'üêç' },
        { name: 'Rana', group: 'Anfibios', emoji: 'üê∏' },
        { name: 'Tibur√≥n', group: 'Peces', emoji: 'ü¶à' },
        { name: 'Ara√±a', group: 'Ar√°cnidos', emoji: 'üï∑Ô∏è' }
    ];
    gameData = {
        animals: animals.sort(() => Math.random() - 0.5),
        classified: { Mam√≠feros: [], Aves: [], Reptiles: [], Anfibios: [], Peces: [], Ar√°cnidos: [] }
    };
    const content = document.getElementById('gameContent');
    content.innerHTML = `
        <h2>Clasificaci√≥n de Animales</h2>
        <p>Arrastra cada animal a su grupo correspondiente:</p>
        <div class="animals-to-classify" style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
            ${animals.map((animal, index) => 
                `<div class="draggable-animal" draggable="true" ondragstart="drag(event)" data-animal="${animal.name}" data-group="${animal.group}">
                    ${animal.emoji} ${animal.name}
                </div>`
            ).join('')}
        </div>
        <div class="classification-groups" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            ${Object.keys(gameData.classified).map(group => 
                `<div class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)" data-group="${group}">
                    <h4>${group}</h4>
                    <div class="dropped-animals" id="zone-${group}"></div>
                </div>`
            ).join('')}
        </div>
        <button class="btn" onclick="checkClasificacion()" style="margin-top: 20px;">Verificar Clasificaci√≥n</button>
    `;
};
window.allowDrop = function allowDrop(ev) { ev.preventDefault(); };
window.drag = function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.dataset.animal);
    ev.dataTransfer.setData("group", ev.target.dataset.group);
};
window.drop = function drop(ev) {
    ev.preventDefault();
    const animalName = ev.dataTransfer.getData("text");
    const correctGroup = ev.dataTransfer.getData("group");
    const dropZone = ev.target.closest('.drop-zone');
    const targetGroup = dropZone.dataset.group;
    const draggedElement = document.querySelector(`[data-animal="${animalName}"]`);
    if (!draggedElement) return;
    const droppedArea = dropZone.querySelector('.dropped-animals');
    if ([...droppedArea.children].some(child => child.dataset.animal === animalName)) return;
    droppedArea.appendChild(draggedElement);
    Object.keys(gameData.classified).forEach(group => {
        gameData.classified[group] = gameData.classified[group].filter(a => a.name !== animalName);
    });
    gameData.classified[targetGroup].push({ name: animalName, correct: correctGroup === targetGroup });
};
window.checkClasificacion = async function checkClasificacion() {
    let correct = 0;
    let total = 0;
    Object.values(gameData.classified).forEach(group => {
        group.forEach(animal => {
            total++;
            if (animal.correct) correct++;
        });
    });
    const percentage = (correct / total) * 100;
    const reward = Math.floor((percentage / 100) * 18);
    if (reward > 0) {
        await sumarCoinsAFila(currentUser, reward);
    }
    const content = document.getElementById('gameContent');
    content.innerHTML = `
        <div class="game-completed">
            <h3>Clasificaci√≥n Completada</h3>
            <div class="score-display">
                Clasificaciones correctas: ${correct}/${total}
                <br>
                Porcentaje: ${percentage.toFixed(1)}%
            </div>
            ${reward > 0 ? 
                `<div class="coins-earned">
                    <div class="coin-icon">‚Çø</div>
                    ¬°Ganaste ${reward} Minecoins!
                </div>` : 
                '<p>¬°Mejora tu clasificaci√≥n para ganar m√°s monedas!</p>'
            }
            <button class="btn" onclick="closeGame()" style="margin-top: 20px;">Cerrar</button>
            <button class="btn" onclick="startClasificacionGame()" style="margin-top: 20px; margin-left: 10px;">Intentar de Nuevo</button>
        </div>
    `;
};